name: Intelligent Keep Alive

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: 

jobs:
  check-and-keep-alive:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Conditional Update
        id: check_date
        run: |
          LAST_COMMIT_TIME=$(git log -1 --format=%ct)
          CURRENT_TIME=$(date +%s)
          DIFF_DAYS=$(( (CURRENT_TIME - LAST_COMMIT_TIME) / 86400 ))
          
          echo "距上次提交已过去: $DIFF_DAYS 天"
          
          if [ $DIFF_DAYS -ge 50 ]; then
            echo "触发更新：已接近 60 天限制。"
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            echo "无需操作：仓库依然活跃。"
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update timestamp and Commit
        if: steps.check_date.outputs.should_update == 'true'
        run: |
          echo "Last active (Automatic): $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > .github/last-active.txt
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/last-active.txt
          git commit -m "chore: smart keep-alive (over 50 days inactivity) [skip ci]"
          git push
